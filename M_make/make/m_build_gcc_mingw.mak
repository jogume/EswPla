#** ***************************************************************************
# \copyright       EswPla FreeRTOS Project
# \file            m_build_gcc_mingw.mak
# \brief           Makefile for GCC MinGW compiler (Windows)
# \Make            GNU Make
#******************************************************************************

include M_make/make/m_hub.mak

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# VPATH for source files
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
VPATH = $(MODULE_SOURCE_PATHS)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Compiler options for C source files
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
COMP_OPTIONS = -O0 -g3 -Wall -Wextra -c -fmessage-length=0 -Wcast-qual -D_WIN32_WINNT=0x0601

ifdef COMPILER_CUSTOM_OPTIONS
	COMP_OPTIONS = $(COMPILER_CUSTOM_OPTIONS)
endif

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Compiler options for C++ source files (if needed)
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
COMP_OPTIONS_CPP = $(COMP_OPTIONS)

ifdef COMPILER_CUSTOM_OPTIONS_CPP
	COMP_OPTIONS_CPP = $(COMPILER_CUSTOM_OPTIONS_CPP)
endif

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Assembler options (if needed)
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
ASM_OPTIONS =

ifdef ASM_CUSTOM_OPTIONS
	ASM_OPTIONS = $(ASM_CUSTOM_OPTIONS)
endif

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Library generation options
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
LIB_OPTIONS = -crs

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Link options
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
LINK_OPTIONS = -Wl,-Map=$(S_PPH_PRJ_MAP) -o $(S_PPH_PRJ_EXE)

ifdef LINKER_CUSTOM_OPTIONS
	LINK_OPTIONS = $(LINKER_CUSTOM_OPTIONS)
else
	LINK_OPTIONS += $(LINKER_ADDITIONAL_OPTIONS)
endif

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Pattern rule: Compile C source files to object files
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
$(S_DPH_MOD_OBJ)/%.o: %.c
	@mkdir -p $(S_DPH_MOD_OBJ)
	$(AM_V_CC)$(T_PTH_BUILD_COMPILER) $(COMP_OPTIONS) $(COMPILER_DEFINE) $(COMPILER_INCLUDE) -o $@ $<

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Pattern rule: Assemble ASM source files to object files
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
$(S_DPH_MOD_OBJ)/%.o: %.s
	@mkdir -p $(S_DPH_MOD_OBJ)
	$(AM_V_CC)$(T_PTH_BUILD_ASM) $(ASM_OPTIONS) $(COMPILER_DEFINE) $(COMPILER_INCLUDE) -o $@ $<

$(S_DPH_MOD_OBJ)/%.o: %.S
	@mkdir -p $(S_DPH_MOD_OBJ)
	$(AM_V_CC)$(T_PTH_BUILD_ASM) $(ASM_OPTIONS) $(COMPILER_DEFINE) $(COMPILER_INCLUDE) -o $@ $<

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: Compile all module source files
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: COMPILE
COMPILE: $(OBJECTS)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: Create module library
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: LIB
LIB: COMPILE $(S_PPH_MOD_LIB)

$(S_PPH_MOD_LIB): $(OBJECTS)
	@mkdir -p $(S_DPH_MOD_LIB)
	$(AM_V_LIB)$(T_PTH_BUILD_LIB) $(LIB_OPTIONS) $@ $^

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: Link all libraries to create executable
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: LINK
LINK: $(S_PPH_PRJ_EXE)

$(S_PPH_PRJ_EXE): $(LIBRARY_QAC)
	@mkdir -p $(S_DPH_PRJ_OUT)
	$(AM_V_GEN)$(T_PTH_BUILD_LINK) $(LINK_OPTIONS) -Wl,--start-group $(LIBRARY_QAC) -lwinmm -Wl,--end-group

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: Clean module build artifacts
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: CLEAN
CLEAN:
	@rm -rf $(S_DPH_MOD_OUT)
	@echo Cleaned $(MODULE_NAME)
