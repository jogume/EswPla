#** ***************************************************************************
# \copyright       EswPla FreeRTOS Project
# \file            makefile.mak
# \brief           Main Makefile for calling targets
# \Make            GNU Make
#******************************************************************************

include M_make/make/m_hub.mak

# Save the current include directories to pass to sub-makes
PROJECT_INCLUDE_DIRS := $(.INCLUDE_DIRS)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Variables for accessing Modules PATHS
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
MAKEFILE_DIR                = $(MAKE_QAC) $(MAKE_NOQAC)

MAKEFILE_DIR_COMPILE       := $(MAKEFILE_DIR:%=%_COMPILE)
MAKEFILE_DIR_CLEAN         := $(MAKEFILE_DIR:%=%_CLEAN)
MAKEFILE_DIR_LIB           := $(MAKEFILE_DIR:%=%_LIB)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Variables for accessing Makefiles
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
COMPILER_MAKEFILE           = $(S_DIR_PROC_MAKE)/m_build_gcc_mingw.mak

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: MODULE_COMPILE - Compile single module
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY : MODULE_COMPILE
MODULE_COMPILE:
	$(AM_V_MAKE)$(MAKE) $(MAKEOPTION) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(MODULE_MAKE_DIR) COMPILE

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: MODULE_LIB - Generate library for single module
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY : MODULE_LIB
MODULE_LIB :
	$(AM_V_MAKE)$(MAKE) $(MAKEOPTION) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(MODULE_MAKE_DIR) LIB

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: MODULE_CLEAN - Clean generated files for single module
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY : MODULE_CLEAN
MODULE_CLEAN :
	$(AM_V_MAKE)$(MAKE) $(MAKEOPTION) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(MODULE_MAKE_DIR) CLEAN

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: COMPILE - Compile all modules
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: $(MAKEFILE_DIR_COMPILE)
$(MAKEFILE_DIR_COMPILE):
	$(AM_V_MAKE)$(MAKE) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(subst _COMPILE,,$@) COMPILE

.PHONY: COMPILE
COMPILE: $(MAKEFILE_DIR_COMPILE)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: LIB - Build libraries for all modules
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: $(MAKEFILE_DIR_LIB)
$(MAKEFILE_DIR_LIB):
	$(AM_V_MAKE)$(MAKE) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(subst _LIB,,$@) LIB

.PHONY: LIB
LIB: $(MAKEFILE_DIR_LIB)

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: BUILD - Build all modules and link
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: BUILD
BUILD: LIB
	$(AM_V_MAKE)$(MAKE) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(firstword $(MAKEFILE_DIR)) LINK

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: CLEAN - Clean all modules
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: $(MAKEFILE_DIR_CLEAN)
$(MAKEFILE_DIR_CLEAN):
	$(AM_V_MAKE)$(MAKE) -f $(COMPILER_MAKEFILE) $(addprefix -I ,$(PROJECT_INCLUDE_DIRS)) -I $(subst _CLEAN,,$@) CLEAN

.PHONY: CLEAN clean
CLEAN clean: $(MAKEFILE_DIR_CLEAN)
	@rm -rf $(PROJECT_NAME)/output
	@echo Cleaned all

#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# Target: all - Default target (build everything)
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
.PHONY: all
all: BUILD
